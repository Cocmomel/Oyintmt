<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>üßÆ Matematika O'yini</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg:#f5f7fb; --card:#ffffff; --accent:#0088cc; --text:#111827; }
    body { margin:0; font-family: Inter, Arial, sans-serif; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; }
    .wrap { max-width:420px; margin:30px auto; padding:18px; }
    .card { background:var(--card); border-radius:12px; padding:18px; box-shadow:0 6px 18px rgba(15,23,42,0.06); text-align:center; }
    h1 { margin:6px 0 12px; font-size:20px; }
    .meta { font-size:13px; color:#6b7280; margin-bottom:12px; }
    .question { font-size:28px; margin:18px 0; font-weight:600; }
    .answers { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
    .ansbtn { flex:1 1 45%; min-width:120px; padding:10px 12px; border-radius:10px; border:none; font-size:18px; cursor:pointer; background:var(--accent); color:white; }
    .ansbtn.small { font-size:16px; padding:8px; }
    .score { margin-top:12px; font-weight:600; }
    footer { margin-top:14px; display:flex; gap:8px; justify-content:center; }
    .ghost { background:transparent; border:1px solid #d1d5db; color:#111827; padding:8px 12px; border-radius:10px; cursor:pointer; }
    .finish { background:#10b981; color:white; border:none; padding:8px 12px; border-radius:10px; cursor:pointer; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üß† Matematika O'yini</h1>
      <div id="userinfo" class="meta">Yuklanmoqda...</div>

      <div id="gameArea">
        <div class="question" id="question">‚Äî</div>
        <div class="answers" id="answers"></div>
        <div class="score" id="score">To'g'ri javoblar: 0</div>
      </div>

      <footer>
        <button class="ghost" id="skipBtn">Keyingisi</button>
        <button class="finish" id="finishBtn">üì§ Yakunlash</button>
      </footer>
    </div>
  </div>

  <script>
    // Telegram WebApp init
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.expand();
      const user = tg.initDataUnsafe?.user || {};
      const name = (user.first_name||'') + (user.last_name?(' '+user.last_name):'');
      document.getElementById('userinfo').innerText = `üë§ ${name} ${user.username?('(@'+user.username+')'):''}`;
    } else {
      document.getElementById('userinfo').innerText = '‚ùó Telegram WebApp muhitida oching';
    }

    // Game logic
    let score = 0;
    let currentAnswer = null;
    let totalAsked = 0;

    function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

    function generateQuestion() {
      // choose difficulty scaling by totalAsked
      const maxN = 10 + Math.min(30, Math.floor(totalAsked/3)*2); // gradually increases
      const a = randInt(1, maxN);
      const b = randInt(1, Math.max(2, Math.min(maxN, Math.round(maxN/2))));
      const ops = ['+', '-', '√ó'];
      const op = ops[randInt(0, ops.length-1)];

      let correct;
      if (op === '+') correct = a + b;
      else if (op === '-') correct = a - b;
      else correct = a * b;

      currentAnswer = correct;
      totalAsked += 1;
      document.getElementById('question').innerText = `${a} ${op} ${b} = ?`;

      // create 3 distractors
      const answers = new Set([correct]);
      while (answers.size < 4) {
        // produce plausible distractors
        const delta = Math.max(1, Math.floor(Math.abs(correct)*0.2)) + randInt(-3,3);
        const candidate = correct + (Math.random()<0.5 ? delta : -delta);
        answers.add(candidate);
      }

      // shuffle and render
      const arr = Array.from(answers).sort(()=>Math.random()-0.5);
      const container = document.getElementById('answers');
      container.innerHTML = '';
      arr.forEach(v=>{
        const btn = document.createElement('button');
        btn.className = 'ansbtn';
        btn.innerText = v;
        btn.onclick = ()=>checkAnswer(v);
        container.appendChild(btn);
      });

      document.getElementById('score').innerText = `To'g'ri javoblar: ${score}`;
    }

    function checkAnswer(selected) {
      if (selected === currentAnswer) {
        score++;
        flash(true);
      } else {
        flash(false);
      }
      generateQuestion();
    }

    function flash(ok){
      const q = document.getElementById('question');
      q.style.transition = 'background 0.18s';
      q.style.background = ok ? '#ecfdf5' : '#fff7ed';
      setTimeout(()=> q.style.background = 'transparent', 180);
    }

    document.getElementById('skipBtn').addEventListener('click', ()=>{
      generateQuestion();
    });

    document.getElementById('finishBtn').addEventListener('click', ()=>{
      // send data back to bot
      const payload = { status: 'game_over', score: score, total: totalAsked };
      if (tg) {
        tg.sendData(JSON.stringify(payload));
      } else {
        alert('Local preview: ' + JSON.stringify(payload));
      }
    });

    // start
    generateQuestion();
  </script>
</body>
</html>